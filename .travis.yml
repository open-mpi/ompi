sudo: required
dist: trusty
language: c
compiler:
    - gcc
os:
    - linux

addons:
    apt:
        packages:
            - autoconf
            - automake
            - libtool
            - libnl-3-200
            - libnl-3-dev
            - libnl-route-3-200
            - libnl-route-3-dev
            - libibverbs-dev
            - librdmacm-dev
            - gcc-5
            - g++-5
            - gfortran-5
        sources:
            - ubuntu-toolchain-r-test

env:
    global:
        - AM_MAKEFLAGS="-j4"
        - CPPFLAGS="-I$HOME/bogus/include"
        - LDFLAGS="-I$HOME/bogus/lib"
        - LD_LIBRARY_PATH="$HOME/bogus/lib"
        - CONFIGURE_ARGS="--prefix=$HOME/bogus CC=gcc-5 CXX=g++-5 FC=gfortran-5"
        - DISTCHECK_CONFIGURE_FLAGS="$CONFIGURE_ARGS"

# install dependencies for the verbs and usnic providers
# libfbric verbs provider cannot current build without RAI_FAMILY
# see https://github.com/ofiwg/libfabric/issues/1553
before_install:
    - cat .git/config || true
    - git branch -av || true
    - git remote show || true
    - git log || true
    - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then dpkg -l | grep -i rdma; fi
    - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then dpkg -l | grep -i libibverbs; fi
    - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then git clone https://github.com/ofiwg/libfabric.git ; fi
    - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then cd libfabric && ./autogen.sh && ./configure --prefix=$HOME/bogus --enable-usnic --disable-verbs && make install && cd .. ; fi
    - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then xcodebuild -version || true ; fi
    - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then gcc-5 --version || true ; fi
    - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew update; fi
    - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew unlink gcc; fi
    - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install gcc; fi
    - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew info gcc; fi
    - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then gcc-5 --version || true ; fi

install:
    - m4 --version
    - autoconf --version
    - automake --version
    - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then libtool --version; else glibtool --version; fi
    - ./autogen.pl
    - if [[ "$TRAVIS_OS_NAME" == "linux" && "$CC" == "gcc" ]]; then ./configure $CONFIGURE_ARGS --with-libfabric=$HOME/bogus --with-usnic --with-verbs; else ./configure $CONFIGURE_ARGS; fi
    - make

script:
    - if [[ "$TRAVIS_OS_NAME" == "linux" && "$CC" == "gcc" ]]; then make distcheck; else make check; fi

notifications:
  email:
    recipients:
      - jsquyres@cisco.com
    on_success: [change]
    on_failure: [always]
